import logging
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes, ConversationHandler

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

BLOOD, HEIGHT, WEIGHT, AGE, ACTIVITY = range(5)
user_data = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Ø³Ù„Ø§Ù…! Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÙ…Ø±ÛŒÙ†ÛŒ Ùˆ ØºØ°Ø§ÛŒÛŒ ğŸ’ª\nÙ„Ø·ÙØ§Ù‹ Ú¯Ø±ÙˆÙ‡ Ø®ÙˆÙ†ÛŒØª Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ù…Ø«Ù„Ø§Ù‹: O+, A-, B+ ...)")
    return BLOOD

async def blood_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_data["blood"] = update.message.text
    await update.message.reply_text("Ù‚Ø¯Øª Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ø¨Ù‡ Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±):")
    return HEIGHT

async def height_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_data["height"] = int(update.message.text)
    await update.message.reply_text("ÙˆØ²Ù†Øª Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ø¨Ù‡ Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…):")
    return WEIGHT

async def weight_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_data["weight"] = int(update.message.text)
    await update.message.reply_text("Ø³Ù†Øª Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†:")
    return AGE

async def age_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_data["age"] = int(update.message.text)
    reply_keyboard = [["Ù…Ø¨ØªØ¯ÛŒ", "Ù…ØªÙˆØ³Ø·", "Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ"]]
    await update.message.reply_text(
        "Ø³Ø·Ø­ ÙØ¹Ø§Ù„ÛŒØªØª Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", 
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True)
    )
    return ACTIVITY

async def activity_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_data["activity"] = update.message.text
    bmi = user_data["weight"] / ((user_data["height"] / 100) ** 2)
    bmi_status = ("Ú©Ù…â€ŒÙˆØ²Ù†" if bmi < 18.5 else "Ù†Ø±Ù…Ø§Ù„" if bmi < 25 else "Ø§Ø¶Ø§ÙÙ‡ ÙˆØ²Ù†" if bmi < 30 else "Ú†Ø§Ù‚")

    response = f"""
âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§:
Ú¯Ø±ÙˆÙ‡ Ø®ÙˆÙ†ÛŒ: {user_data["blood"]}
Ù‚Ø¯: {user_data["height"]} Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±
ÙˆØ²Ù†: {user_data["weight"]} Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…
Ø³Ù†: {user_data["age"]}
Ø³Ø·Ø­ ÙØ¹Ø§Ù„ÛŒØª: {user_data["activity"]}
Ø´Ø§Ø®Øµ ØªÙˆØ¯Ù‡ Ø¨Ø¯Ù†ÛŒ (BMI): {bmi:.1f} â†’ {bmi_status}

ğŸ“‹ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:
- ØªÙ…Ø±ÛŒÙ†: Ûµ Ø±ÙˆØ² Ø¯Ø± Ù‡ÙØªÙ‡ØŒ ØªØ±Ú©ÛŒØ¨ÛŒ Ø§Ø² Ù‡ÙˆØ§Ø²ÛŒ Ùˆ Ù…Ù‚Ø§ÙˆÙ…ØªÛŒ
- ØªØºØ°ÛŒÙ‡: {"Ù¾Ø±Ù¾Ø±ÙˆØªØ¦ÛŒÙ† Ùˆ Ù¾Ø±Ú©Ø§Ù„Ø±ÛŒ" if bmi < 18.5 else "Ù…ØªØ¹Ø§Ø¯Ù„ Ø¨Ø§ Ù¾Ø±ÙˆØªØ¦ÛŒÙ† Ù…ØªÙˆØ³Ø·" if bmi < 25 else "Ú©Ù…â€ŒÚ©Ø§Ù„Ø±ÛŒ Ùˆ Ú©Ù…â€ŒÚ†Ø±Ø¨"}

ğŸ’¬ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ /start Ø±Ø§ Ø¨Ø²Ù†.
"""
    await update.message.reply_text(response)
    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯. Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ /start Ø±Ø§ Ø¨Ø²Ù†.")
    return ConversationHandler.END

def main():
    import os
    TOKEN = os.environ.get("BOT_TOKEN")
    app = ApplicationBuilder().token(TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            BLOOD: [MessageHandler(filters.TEXT & ~filters.COMMAND, blood_input)],
            HEIGHT: [MessageHandler(fil]()
